{
  "version": "1.0.1",
  "module": "SUPPLEMENTAL_FEE",
  "policy": {
    "monthlyCardVolumeIsGross": true,
    "flatRate": {
      "autoFormula": "fee/(1+fee)",
      "editable": true,
      "resetHint": "Reset to auto",
      "caption": "Bank mapping: Fee ÷ (1+Fee)"
    },
    "rounding": {
      "internalPrecision": 12,
      "displayDecimals": 2,
      "negativeStyle": "leadingMinus"
    }
  },
  "radios": {
    "tipTiming": {
      "id": "TIP_TIMING",
      "options": [
        {
          "id": "BEFORE_TIP",
          "label": "Tip handwritten (fee before tip)",
          "subtext": "Tip is added after the card is processed; fee is calculated before tip."
        },
        {
          "id": "AFTER_TIP",
          "label": "Tip at time of sale (fee after tip)",
          "subtext": "Tip is part of the transaction when the fee is calculated."
        }
      ]
    },
    "feeTaxBasis": {
      "id": "FEE_TAX_BASIS",
      "options": [
        {
          "id": "POST_TAX",
          "label": "Apply fee to post-tax amount",
          "subtext": "Tax is added before fee."
        },
        {
          "id": "PRE_TAX",
          "label": "Apply fee to pre-tax amount",
          "subtext": "Fee is calculated before tax."
        }
      ]
    }
  },
  "ui": {
    "removeControls": ["CARD_VOLUME_BASIS"],
    "renameCards": {
      "DMPProfitability": "Gross Profit"
    },
    "orderOfOperationsRibbon": true,
    "orderOfOperationsTextByCombo": {
      "BEFORE_TIP__POST_TAX": "Pre-Tax Base → +Tax → +Supplemental Fee → +Tip",
      "BEFORE_TIP__PRE_TAX": "Pre-Tax Base → +Supplemental Fee → +Tax → +Tip",
      "AFTER_TIP__POST_TAX": "Pre-Tax Base → +Tax → +Tip → +Supplemental Fee",
      "AFTER_TIP__PRE_TAX": "Pre-Tax Base → +Tax → +Tip → +Supplemental Fee"
    },
    "colors": {
      "cost": "red",
      "feesCollected": "green",
      "bases": "neutral",
      "net": "teal"
    },
    "tooltips": {
      "flatRate": "Calculated as Fee ÷ (1+Fee). Provided by bank; not intended to fully offset processor charges.",
      "feeCollectedCards": "Fee is applied to the Fee Base for the selected options.",
      "tipAmount": "Tip is calculated on the subtotal indicated by the current options.",
      "processedTotal": "Amount the processor charges on after fee and tip.",
      "recovery": "Under/Over = Supplemental Fee (Cards) − Processor Charge. Positive = fee covers processor charge; negative = fee falls short.",
      "savingsCardsOnly": "Savings can be negative if processor charges exceed the fee collected on cards."
    }
  },
  "inputs": [
    { "id": "grossCards", "label": "Monthly Card Volume (Gross)", "type": "currency" },
    { "id": "cashVol", "label": "Monthly Cash Volume", "type": "currency" },
    { "id": "currRate", "label": "Current Processing Rate (%)", "type": "percent" },
    { "id": "interchange", "label": "Interchange Cost (%)", "type": "percent" },
    { "id": "tax", "label": "Tax Rate (%)", "type": "percent" },
    { "id": "tip", "label": "Tip Rate (%)", "type": "percent" },
    { "id": "fee", "label": "Supplemental Fee (%)", "type": "percent" },
    { "id": "flatRate", "label": "Flat Rate % (Bank Mapping)", "type": "percent", "auto": "fee/(1+fee)", "editable": true, "showResetLink": true }
  ],
  "derivedPanels": [
    {
      "id": "derivedTotals",
      "title": "Derived Bases & Totals",
      "fieldsOrder": [
        "base",
        "feeBaseCards",
        "supplementalFeeCards",
        "tipBase",
        "tipAmount",
        "cardsProcessed"
      ],
      "fields": [
        { "id": "base", "label": "Pre-Tax Base (from Gross)", "type": "currency" },
        { "id": "feeBaseCards", "label": "Fee Base — Cards", "type": "currency", "captionDynamic": true },
        { "id": "supplementalFeeCards", "label": "Supplemental Fee Collected — Cards", "type": "currency" },
        { "id": "tipBase", "label": "Tip Base", "type": "currency", "captionDynamic": true },
        { "id": "tipAmount", "label": "Tip Amount", "type": "currency" },
        { "id": "cardsProcessed", "label": "Card Processed Total", "type": "currency" }
      ]
    },
    {
      "id": "processorRecovery",
      "title": "Processor Charges & Recovery",
      "fieldsOrder": [
        "flatRate",
        "procCharge",
        "recovery",
        "coveragePct"
      ],
      "fields": [
        { "id": "procCharge", "label": "Processor Charge on Cards", "type": "currency" },
        { "id": "recovery", "label": "Card Under/Over-Recovery", "type": "currency", "inlineMath": "Supplemental Fee (Cards) – Processor Charge" },
        { "id": "coveragePct", "label": "Coverage %", "type": "percent" }
      ]
    },
    {
      "id": "savingsNet",
      "title": "Savings & Net",
      "fieldsOrder": [
        "currentCost",
        "savingsCardsOnly",
        "supplementalFeeCash",
        "netMonthly",
        "netAnnual"
      ],
      "fields": [
        { "id": "currentCost", "label": "Current Processing Cost (Today)", "type": "currency" },
        { "id": "savingsCardsOnly", "label": "Processing Cost Savings (Cards Only)", "type": "currency" },
        { "id": "supplementalFeeCash", "label": "Supplemental Fee Collected — Cash", "type": "currency" },
        { "id": "netMonthly", "label": "Total Net Gain (Monthly)", "type": "currency" },
        { "id": "netAnnual", "label": "Annual Net Gain", "type": "currency" }
      ]
    },
    {
      "id": "profit",
      "title": "Gross Profit",
      "fieldsOrder": [ "grossProfit" ],
      "fields": [
        { "id": "grossProfit", "label": "Gross Profit (Cards)", "type": "currency" }
      ]
    }
  ],
  "math": {
    "shared": {
      "base": "grossCards/(1+tax+tip)",
      "postTaxPreTip": "base*(1+tax)",
      "flatRateAuto": "fee/(1+fee)"
    },
    "combos": {
      "BEFORE_TIP__POST_TAX": {
        "ledger": "Pre-Tax Base → +Tax → +Supplemental Fee → +Tip",
        "feeBaseCards": "postTaxPreTip",
        "supplementalFeeCards": "feeBaseCards*fee",
        "tipBase": "postTaxPreTip*(1+fee)",
        "tipAmount": "tipBase*tip",
        "cardsProcessed": "postTaxPreTip*(1+fee)*(1+tip)"
      },
      "BEFORE_TIP__PRE_TAX": {
        "ledger": "Pre-Tax Base → +Supplemental Fee → +Tax → +Tip",
        "feeBaseCards": "base",
        "supplementalFeeCards": "feeBaseCards*fee",
        "tipBase": "base*(1+fee)*(1+tax)",
        "tipAmount": "tipBase*tip",
        "cardsProcessed": "base*(1+fee)*(1+tax)*(1+tip)"
      },
      "AFTER_TIP__POST_TAX": {
        "ledger": "Pre-Tax Base → +Tax → +Tip → +Supplemental Fee",
        "feeBaseCards": "postTaxPreTip*(1+tip)",
        "supplementalFeeCards": "feeBaseCards*fee",
        "tipBase": "postTaxPreTip",
        "tipAmount": "tipBase*tip",
        "cardsProcessed": "postTaxPreTip*(1+tip)*(1+fee)"
      },
      "AFTER_TIP__PRE_TAX": {
        "ledger": "Pre-Tax Base → +Tax → +Tip → +Supplemental Fee",
        "feeBaseCards": "base*(1+tip)",
        "supplementalFeeCards": "feeBaseCards*fee",
        "tipBase": "postTaxPreTip",
        "tipAmount": "tipBase*tip",
        "cardsProcessed": "(postTaxPreTip*(1+tip)) + (fee*feeBaseCards)"
      }
    },
    "chargesAndSavings": {
      "procCharge": "cardsProcessed*flatRate",
      "recovery": "supplementalFeeCards - procCharge",
      "coveragePct": "IF(procCharge==0,0,supplementalFeeCards/procCharge)",
      "currentCost": "grossCards*currRate",
      "savingsCardsOnly": "currentCost - (procCharge - supplementalFeeCards)",
      "supplementalFeeCash": "cashVol*fee",
      "netMonthly": "savingsCardsOnly + supplementalFeeCash",
      "netAnnual": "netMonthly*12",
      "grossProfit": "(flatRate - interchange)*cardsProcessed"
    }
  },
  "display": {
    "sectionOrder": ["derivedTotals", "processorRecovery", "savingsNet", "profit"],
    "showFlatRateInTwoPlaces": true,
    "inlineMathUnderRecovery": "Under/Over = Supplemental Fee (Cards) − Processor Charge"
  },
  "qaExamples": [
    {
      "name": "A) Handwritten Tip + Post-Tax Fee",
      "combo": "BEFORE_TIP__POST_TAX",
      "inputs": {
        "grossCards": 20000,
        "cashVol": 5000,
        "currRate": 0.0225,
        "interchange": 0.02,
        "tax": 0.10,
        "tip": 0.20,
        "fee": 0.04,
        "flatRate": "AUTO"
      },
      "expect": {
        "base": 15384.61538462,
        "feeBaseCards": 16923.07692308,
        "supplementalFeeCards": 676.92307692,
        "tipBase": 17600.00000000,
        "tipAmount": 3520.00000000,
        "cardsProcessed": 21120.00000000,
        "procCharge": 812.30769231,
        "recovery": -135.38461538,
        "currentCost": 450.00000000,
        "savingsCardsOnly": 314.61538462,
        "supplementalFeeCash": 200.00000000,
        "netMonthly": 514.61538462,
        "netAnnual": 6175.38461538,
        "grossProfit": 389.90769231
      }
    },
    {
      "name": "B) Handwritten Tip + Pre-Tax Fee",
      "combo": "BEFORE_TIP__PRE_TAX",
      "inputs": {
        "grossCards": 20000,
        "cashVol": 5000,
        "currRate": 0.0225,
        "interchange": 0.02,
        "tax": 0.10,
        "tip": 0.20,
        "fee": 0.04,
        "flatRate": "AUTO"
      },
      "expect": {
        "base": 15384.61538462,
        "feeBaseCards": 15384.61538462,
        "supplementalFeeCards": 615.38461538,
        "tipBase": 17600.00000000,
        "tipAmount": 3520.00000000,
        "cardsProcessed": 21120.00000000,
        "procCharge": 812.30769231,
        "recovery": -196.92307692,
        "currentCost": 450.00000000,
        "savingsCardsOnly": 253.07692308,
        "supplementalFeeCash": 200.00000000,
        "netMonthly": 453.07692308,
        "netAnnual": 5436.92307692,
        "grossProfit": 389.90769231
      }
    },
    {
      "name": "C) Tip at Time of Sale + Post-Tax Fee",
      "combo": "AFTER_TIP__POST_TAX",
      "inputs": {
        "grossCards": 20000,
        "cashVol": 5000,
        "currRate": 0.0225,
        "interchange": 0.02,
        "tax": 0.10,
        "tip": 0.20,
        "fee": 0.04,
        "flatRate": "AUTO"
      },
      "expect": {
        "base": 15384.61538462,
        "tipBase": 16923.07692308,
        "tipAmount": 3384.61538462,
        "feeBaseCards": 20307.69230769,
        "supplementalFeeCards": 812.30769231,
        "cardsProcessed": 21120.00000000,
        "procCharge": 812.30769231,
        "recovery": 0.00000000,
        "currentCost": 450.00000000,
        "savingsCardsOnly": 450.00000000,
        "supplementalFeeCash": 200.00000000,
        "netMonthly": 650.00000000,
        "netAnnual": 7800.00000000,
        "grossProfit": 389.90769231
      }
    },
    {
      "name": "D) Tip at Time of Sale + Pre-Tax Fee",
      "combo": "AFTER_TIP__PRE_TAX",
      "inputs": {
        "grossCards": 20000,
        "cashVol": 5000,
        "currRate": 0.0225,
        "interchange": 0.02,
        "tax": 0.10,
        "tip": 0.20,
        "fee": 0.04,
        "flatRate": "AUTO"
      },
      "expect": {
        "base": 15384.61538462,
        "tipBase": 16923.07692308,
        "tipAmount": 3384.61538462,
        "feeBaseCards": 18461.53846154,
        "supplementalFeeCards": 738.46153846,
        "cardsProcessed": 21046.15384615,
        "procCharge": 809.46745562,
        "recovery": -71.00591716,
        "currentCost": 450.00000000,
        "savingsCardsOnly": 378.99408284,
        "supplementalFeeCash": 200.00000000,
        "netMonthly": 578.99408284,
        "netAnnual": 6947.92899408,
        "grossProfit": 388.54437870
      }
    }
  ]
}
