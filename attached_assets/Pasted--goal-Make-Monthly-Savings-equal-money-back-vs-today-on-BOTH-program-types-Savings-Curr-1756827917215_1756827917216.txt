{
  "goal": "Make Monthly Savings equal 'money back vs today' on BOTH program types. Savings = Current Processing Cost + Net Cost for Processing Cards + Fee Collected on Cash. Add Annual Savings under Savings. Keep payout lines only in DMP panel. Do not change 'Total Net Gain Rev'.",
  "files_to_edit": [
    "client/src/utils/calculations.ts",
    "client/src/components/calculator/ProcessingSavings.tsx",
    "server/pdf-generator-branded.ts"
  ],
  "instructions": [
    "utils/calculations.ts:",
    "  - After existing per-program math is computed, ensure these canonical fields are present in results for BOTH branches (SUPPLEMENTAL_FEE and DUAL_PRICING/CASH_DISCOUNT):",
    "      • currentCost: number                                    // Card Volume × Current Rate",
    "      • feeCollectedOnCards OR cardPriceIncreaseCollected: number",
    "      • feeCollectedOnCash: number (0 for Dual Pricing/Cash Discount)",
    "      • programCardFees: number                                // the processor fees under the program",
    "      • netCostForProcessingCards: number                      // fee/markup collected on cards − programCardFees (signed)",
    "  - SUPPLEMENTAL_FEE branch (keep your existing logic, just normalize names):",
    "      // Already computed elsewhere:",
    "      // cardProcessedTotal, processorChargeOnCards, cardFeeCollected, cashFeeCollected, etc.",
    "      const programCardFees = processorChargeOnCards;",
    "      const netCostForProcessingCards = cardFeeCollected - programCardFees;  // signed; negative means shortfall",
    "      const feeCollectedOnCash = cashFeeCollected;",
    "      // Savings and Annual Savings (NEW canonical definitions):",
    "      const monthlySavings = currentCost + netCostForProcessingCards + feeCollectedOnCash;",
    "      const annualSavings  = monthlySavings * 12;",
    "      Object.assign(results, { programCardFees, netCostForProcessingCards, feeCollectedOnCash, monthlySavings, annualSavings });",
    "  - DUAL_PRICING/CASH_DISCOUNT branch:",
    "      // Ensure we expose the two components needed:",
    "      //   cardPriceIncreaseCollected (a.k.a. markup on card sales),",
    "      //   programCardFees (your existing revenue-adjusted fee total the merchant still pays).",
    "      // If you already return 'revenueAdjustedProcessingCost' as the out-of-pocket fees, set:",
    "      const programCardFees = revenueAdjustedProcessingCost;   // existing variable in your DP math",
    "      const feeCollectedOnCards = cardPriceIncreaseCollected;  // existing variable in your DP math",
    "      const netCostForProcessingCards = feeCollectedOnCards - programCardFees;  // signed",
    "      const feeCollectedOnCash = 0;  // DP/CD has no cash fee",
    "      const monthlySavings = currentCost + netCostForProcessingCards + feeCollectedOnCash;",
    "      const annualSavings  = monthlySavings * 12;",
    "      Object.assign(results, { programCardFees, netCostForProcessingCards, feeCollectedOnCash, monthlySavings, annualSavings });",
    "",
    "client/src/components/calculator/ProcessingSavings.tsx:",
    "  - For BOTH program types:",
    "      • Keep your existing rows for 'Current Processing Cost', 'Net Cost for Processing Cards (include tax + tips)', 'Fee Collected on Cash'.",
    "      • Rename/ensure the section total label is 'Savings' and bind to results.monthlySavings.",
    "      • Directly beneath, show 'Annual Savings' using results.annualSavings, then stop.",
    "      • Ensure NO payout lines (Gross Profit, Skytab bonuses) render here (they belong only in the DMP panel).",
    "",
    "server/pdf-generator-branded.ts:",
    "  - Mirror the same placement as the UI:",
    "      • In Supplemental Fee and in Dual Pricing/Cash Discount PDFs, the 'Savings' section shows the three component rows and the 'Savings' total.",
    "      • Immediately under the 'Savings' total, show 'Annual Savings'.",
    "      • Do not use 'Total Net Gain Rev' to compute Savings; it remains a separate display elsewhere as today.",
    "      • Ensure payout lines appear only in the DMP/payout section, not in the main Savings block."
  ],
  "tests": [
    "Supplemental Fee — 'fee added before tips': Card=$20,000; Cash=$5,000; Tax=10%; Tip=20%; Fee=4%; FR=3.85%; Current=2%.",
    "  - currentCost = 20,000*2% = 400.00",
    "  - feeCollectedOnCards = 20,000*1.10*4% = 880.00",
    "  - programCardFees = 20,000*1.10*1.04*1.20*3.85% ≈ 1,057.06",
    "  - netCostForProcessingCards = 880.00 − 1,057.06 = −177.06",
    "  - feeCollectedOnCash = 5,000*4% = 200.00",
    "  - Savings = 400.00 + (−177.06) + 200.00 = 422.94",
    "  - Annual Savings = 422.94*12 = 5,075.28",
    "Supplemental Fee — 'fee added after tips':",
    "  - feeCollectedOnCards = 20,000*1.10*1.20*4% = 1,056.00",
    "  - programCardFees remains ≈ 1,057.06",
    "  - netCostForProcessingCards = 1,056.00 − 1,057.06 = −1.06",
    "  - Savings = 400.00 + (−1.06) + 200.00 = 598.94",
    "Dual Pricing/Cash Discount (sanity):",
    "  - Savings = currentCost + (cardPriceIncreaseCollected − programCardFees) + 0",
    "  - Annual Savings = monthlySavings*12",
    "UI/PDF:",
    "  - 'Savings' total equals the formula above in both program types.",
    "  - 'Annual Savings' appears directly under 'Savings'.",
    "  - No payout rows appear in the Monthly Savings card or PDF Savings block."
  ],
  "success_criteria": [
    "Both program types compute Savings as 'money back vs today'.",
    "Annual Savings sits directly under Savings in UI and PDF.",
    "Payout rows appear only in the DMP panel/section.",
    "No use of 'Total Net Gain Rev' in the Savings calculation."
  ]
}
