{
  "goal": "Dual Pricing: compute new program cost as Flat Rate × Adjusted Card Volume, where Adjusted Card Volume includes price differential, tax, and tip. Savings = Current Cost + (Markup − Program Card Fees). Leave Supplemental Fee logic unchanged.",
  "files_to_edit": [
    "client/src/utils/calculations.ts",
    "client/src/components/calculator/DualPricingBreakdown.tsx",
    "server/pdf-generator-branded.ts"
  ],
  "instructions": [
    "utils/calculations.ts (DUAL_PRICING/CASH_DISCOUNT branch):",
    "  // Read inputs",
    "  const cc   = inputs.monthlyVolume || 0;           // monthly card volume (current world)",
    "  const tax  = (inputs.taxRate || 0) / 100;",
    "  const tip  = (inputs.tipRate || 0) / 100;",
    "  const pd   = (inputs.priceDifferential || 0) / 100;",
    "  const fr   = (inputs.flatRatePct || 0) / 100;     // what DMP charges merchant under DP",
    "  const curr = (inputs.currentRate || 0) / 100;",
    "",
    "  // 1) Recover base (pre-tax, pre-tip) using the additive model used elsewhere in the app",
    "  const base = cc / (1 + tax + tip);",
    "",
    "  // 2) Adjusted Card Volume includes markup, tax, and tip (your requested definition)",
    "  const adjustedCardVolume = base * (1 + pd) * (1 + tax) * (1 + tip);",
    "",
    "  // 3) Program card fees (new cost)",
    "  const programCardFees = adjustedCardVolume * fr;",
    "",
    "  // 4) Markup collected on cards",
    "  const cardPriceIncreaseCollected = base * pd;",
    "",
    "  // 5) Baseline current processing cost",
    "  const currentCost = cc * curr;",
    "",
    "  // 6) Signed net on cards and Savings",
    "  const netCostForProcessingCards = cardPriceIncreaseCollected - programCardFees; // can be negative",
    "  const feeCollectedOnCash = 0; // DP/CD has no cash fee",
    "  const monthlySavings = currentCost + netCostForProcessingCards + feeCollectedOnCash;",
    "  const annualSavings  = monthlySavings * 12;",
    "",
    "  Object.assign(results, {",
    "    baseVolume: base,",
    "    adjustedCardVolume,",
    "    cardPriceIncreaseCollected,",
    "    programCardFees,",
    "    currentCost,",
    "    netCostForProcessingCards,",
    "    feeCollectedOnCash,",
    "    monthlySavings,",
    "    annualSavings",
    "  });",
    "",
    "DualPricingBreakdown.tsx:",
    "  - Bind 'Adjusted Card Volume' to results.adjustedCardVolume (this now includes markup, tax & tip).",
    "  - Bind the 'Total Processing Fees Charged' / 'Revenue-Adjusted Processing Cost' to results.programCardFees.",
    "",
    "server/pdf-generator-branded.ts:",
    "  - For the Dual Pricing PDF, mirror the same values: Adjusted Card Volume = results.adjustedCardVolume; Program cost = results.programCardFees; Savings = results.monthlySavings; Annual Savings = results.annualSavings.",
    "  - Leave Supplemental Fee sections unchanged."
  ],
  "tests": [
    "Inputs: Card=20000, Tax=10%, Tip=20%, PD=4%, FR=4%, Current=2%.",
    "Expect:",
    "  base ≈ 15384.62",
    "  adjustedCardVolume ≈ 21120.00",
    "  programCardFees ≈ 844.80",
    "  cardPriceIncreaseCollected ≈ 615.38",
    "  netCostForProcessingCards ≈ -229.42",
    "  Savings ≈ 170.58, Annual ≈ 2047.00",
    "UI/PDF show these exact values in the DP side; Supplemental Fee side unaffected."
  ],
  "success_criteria": [
    "Dual Pricing new cost equals Flat Rate × Adjusted Card Volume (incl. markup, tax & tip).",
    "Adjusted Card Volume reflects markup, tax & tip, not just base+tips.",
    "Savings equals Current Cost + (Markup − Program Card Fees).",
    "Supplemental Fee logic unchanged."
  ]
}
