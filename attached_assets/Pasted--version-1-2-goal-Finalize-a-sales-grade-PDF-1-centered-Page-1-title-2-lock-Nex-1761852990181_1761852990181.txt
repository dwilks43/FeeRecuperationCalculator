{
  "version": "1.2",
  "goal": "Finalize a sales-grade PDF: (1) centered Page-1 title, (2) lock Next Steps as a horizontal band on Page 1, (3) humanize program label (Dual Pricing, not Dual_Pricing), (4) guard empty/undefined contact fields, (5) clean pagination and numeric alignment, (6) add concise Assumptions card, (7) set PDF metadata. Keep DocRaptor/Prince CSS friendly and do not recompute values (use frozen calculatedValues).",
  "context": {
    "stack": "React/Vite + DocRaptor (Prince CSS)",
    "principles": [
      "No external webfonts — use system stack.",
      "Right-align all numeric cells; use tabular/lining numerals.",
      "Avoid awkward page breaks with break-inside/page-break-inside: avoid.",
      "Keep Page 1 decisive: Title → KPIs → Next Steps."
    ]
  },
  "files_create_or_update": [
    {
      "path": "src/pdf/styles/mvp-polish.css",
      "contents": "/* ===== MVP Polish + Page 1 horizontal Next Steps ===== */\\n@page { size: Letter; margin: 0.6in; @bottom-right { content: \\\"Page \\\" counter(page) \\\" of \\\" counter(pages); font-size: 10px; color: #6A6F7A; } }\\n:root{ --brand:#0F60D8; --ink:#151922; --muted:#6A6F7A; --line:#E6E8EC; --bg:#F7F9FC; --good:#0E8A3D; }\\nhtml,body{ font-family:system-ui,-apple-system,\\\"Segoe UI\\\",Roboto,Arial,sans-serif; font-size:12px; line-height:1.45; color:var(--ink); -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale; }\\n/* Title */\\n.h1{ text-align:center; font-size:20px; font-weight:800; letter-spacing:-0.2px; margin:0 0 6px; }\\n.title-sub{ text-align:center; color:var(--muted); margin-bottom:8px; }\\n.title-rule{ height:1px; background:var(--line); width:72%; margin:6px auto 10px; }\\n/* Layout */\\n.section{ margin:16px 0; }\\n.card{ border:1px solid var(--line); border-radius:12px; background:#fff; padding:14px; break-inside:avoid; page-break-inside:avoid; }\\n/* KPIs */\\n.kpis{ display:grid; grid-template-columns:repeat(3,1fr); gap:10px; }\\n.kpi{ border:1px solid var(--line); border-radius:12px; background:var(--bg); padding:14px; break-inside:avoid; }\\n.kpi .label{ font-size:10px; color:var(--muted); text-transform:uppercase; letter-spacing:.05em; }\\n.kpi .value{ font-size:22px; font-weight:800; margin-top:2px; font-feature-settings:\\\"tnum\\\" 1,\\\"lnum\\\" 1; }\\n.kpi .delta{ font-size:10px; color:var(--muted); margin-top:4px; }\\n/* Tables */\\n.table{ width:100%; border-collapse:collapse; }\\n.table th,.table td{ padding:8px 10px; border-bottom:1px solid var(--line); vertical-align:top; }\\n.table th{ text-align:left; font-size:10px; color:var(--muted); text-transform:uppercase; letter-spacing:.05em; }\\n.table .num{ text-align:right; white-space:nowrap; font-feature-settings:\\\"tnum\\\" 1,\\\"lnum\\\" 1; }\\n/* Next Steps — horizontal band */\\n.next-steps-row{ display:grid; grid-template-columns:repeat(3,1fr); gap:10px; }\\n.next-steps-card{ border:1px solid var(--line); border-radius:12px; padding:12px; background:#fff; break-inside:avoid; page-break-inside:avoid; }\\n.next-steps-card .h3{ font-size:12px; font-weight:700; margin:0 0 6px; }\\n/* Optional allocation pills (owner-first framing) */\\n.pills{ display:grid; grid-template-columns:repeat(4,1fr); gap:8px; }\\n.pill{ background:var(--bg); border:1px solid var(--line); border-radius:999px; padding:8px 10px; text-align:center; font-size:10px; }\\n/* Micro */\\n.small{ font-size:10px; color:var(--muted); }\\np{ orphans:3; widows:3; }\\n.text-brand{ color:var(--brand); }"
    },
    {
      "path": "src/pdf/helpers/formatters.ts",
      "contents": "export const fmtMoney = (n:number) => new Intl.NumberFormat('en-US',{ style:'currency', currency:'USD', maximumFractionDigits:2 }).format(n);\\nexport const fmtPct = (n:number, digits=2) => `${(Math.round(n*100)/100).toFixed(digits)}%`;\\nexport const safeJoin = (...parts:(string|undefined|null)[]) => parts.filter(Boolean).join(' ');\\nexport const titleCase = (s:string) => s.toLowerCase().replace(/\\b[a-z]/g,c=>c.toUpperCase());\\nexport const humanizeProgram = (s?:string) => s ? titleCase(s.replace(/_/g,' ')) : '';"
    },
    {
      "path": "scripts/docraptor-test.js",
      "contents": "const fs = require('fs');\\nconst DocRaptor = require('docraptor');\\nconst client = new DocRaptor.DocApi();\\nclient.apiClient.authentications['api_key'].apiKey = process.env.DOCRAPTOR_API_KEY;\\n(async () => {\\n  const html = fs.readFileSync('dist/pdf/Report.html', 'utf8');\\n  const createReq = new DocRaptor.DocCreate();\\n  createReq.test = true; // switch to false when final\\n  createReq.name = 'DMP_Fee_Recovery_Report_Test.pdf';\\n  createReq.documentType = 'pdf';\\n  createReq.documentContent = html;\\n  createReq.princeOptions = { media: 'print', pdf_title: 'DMP Fee Recovery Report', pdf_subject: 'Estimated Savings Summary', pdf_author: 'Dynamic Merchant Processing' };\\n  const pdf = await client.createDoc(createReq);\\n  fs.writeFileSync('DMP_Fee_Recovery_Report_Test.pdf', pdf);\\n  console.log('PDF written: DMP_Fee_Recovery_Report_Test.pdf');\\n})();"
    }
  ],
  "edits": [
    {
      "path": "src/pdf/templates/Report.html",
      "description": "Link the updated CSS (load last so it wins).",
      "find": "</head>",
      "replace": "  <link rel=\\"stylesheet\\" href=\\"../styles/mvp-polish.css\\" />\\n</head>"
    },
    {
      "path": "src/pdf/templates/Report.html",
      "description": "Replace any shouty/old title block with centered title + subline + thin rule.",
      "find_regex": "(<h1[\\s\\S]*?</h1>|<div[^>]*class=[\\\"']([^\\\"']*)h1([^\\\"']*)[\\\"'][\\s\\S]*?</div>)[\\s\\S]*?(?=<div class=\\\"kpis\\\"|<section|<div class=\\\"section\\\")",
      "replace": "<div class=\\"h1\\">Fee Recovery Analysis<\\/div>\\n<div class=\\"title-sub\\">{{merchantName}} • {{reportDate}} • Report #{{reportId}}<\\/div>\\n<div class=\\"title-rule\\"><\\/div>\\n"
    },
    {
      "path": "src/pdf/templates/Report.html",
      "description": "Ensure the KPI block is calm/professional and append the horizontal Next Steps band directly after it (Page 1).",
      "find_regex": "<div class=\\\"kpis\\\"[\\s\\S]*?<\\/div>",
      "replace": "<div class=\\\"kpis\\\" style=\\\"margin-top:10px;\\\">\\n  <div class=\\\"kpi\\\">\\n    <div class=\\\"label\\\">Monthly Savings (Est.)<\\/div>\\n    <div class=\\\"value\\\">${{monthlySavings}}<\\/div>\\n    <div class=\\\"delta subtle\\\">Annualized: ${{annualSavings}}<\\/div>\\n  <\\/div>\\n  <div class=\\\"kpi\\\">\\n    <div class=\\\"label\\\">Cost Reduction<\\/div>\\n    <div class=\\\"value\\\">{{costReductionPct}}%<\\/div>\\n    <div class=\\\"delta subtle\\\">vs current effective cost<\\/div>\\n  <\\/div>\\n  <div class=\\\"kpi\\\">\\n    <div class=\\\"label\\\">Program<\\/div>\\n    <div class=\\\"value\\\">{{programLabel}}<\\/div>\\n    <div class=\\\"delta\\\"><span class=\\\"tag\\\">Compliant<\\/span><\\/div>\\n  <\\/div>\\n<\\/div>\\n\\n<!-- Horizontal Next Steps band on Page 1 -->\\n<div class=\\\"section next-steps-row avoid-break\\\">\\n  <div class=\\\"next-steps-card\\\"><div class=\\\"h3\\\">1) Confirm Inputs<\\/div><div class=\\\"small\\\">Validate card mix, tax/tip, and price differential.<\\/div><\\/div>\\n  <div class=\\\"next-steps-card\\\"><div class=\\\"h3\\\">2) Schedule Install<\\/div><div class=\\\"small\\\">Pick onboarding window; we prep config & staff.<\\/div><\\/div>\\n  <div class=\\\"next-steps-card\\\"><div class=\\\"h3\\\">3) Go Live<\\/div><div class=\\\"small\\\"><strong>Annualized impact:<\\/strong> ${{annualSavings}}<\\/div>{{#QR_BOOKING_BASE64}}<div style=\\\"margin-top:8px; text-align:center;\\\"><img src=\\\"data:image/png;base64,{{QR_BOOKING_BASE64}}\\\" alt=\\\"Book\\\" style=\\\"height:56px; border:1px solid var(--line); border-radius:8px;\\\"><\\/div>{{/QR_BOOKING_BASE64}}<\\/div>\\n<\\/div>"
    },
    {
      "path": "src/pdf/templates/Report.html",
      "description": "Optionally add owner-framing allocation pills (after Next Steps, before any charts).",
      "find": "</div><!-- end of section or kpis container -->",
      "replace": "</div>\\n<div class=\\\"section pills avoid-break\\\">\\n  <div class=\\\"pill\\\">${{monthlySavings}}/mo → Labor relief<\\/div>\\n  <div class=\\\"pill\\\">${{quarterlySavings}}/qtr → Smallwares<\\/div>\\n  <div class=\\\"pill\\\">${{annualSavings}}/yr → Cap-ex<\\/div>\\n  <div class=\\\"pill\\\">Marketing fund → Local promos<\\/div>\\n<\\/div>"
    },
    {
      "path": "src/pdf/templates/Report.html",
      "description": "Guard rep contact fields so blanks/undefined don't print.",
      "find_regex": "(<div[^>]*id=[\\\"']rep-contact[\\\"'][^>]*>)[\\s\\S]*?(</div>)",
      "replace": "$1\\n  {{#repName}}<div class=\\\"subtle\\\"><strong>{{repName}}<\\/strong><\\/div>{{/repName}}\\n  {{#repEmail}}<div class=\\\"subtle\\\">Email: {{repEmail}}<\\/div>{{/repEmail}}\\n  {{#repPhone}}<div class=\\\"subtle\\\">Phone: {{repPhone}}<\\/div>{{/repPhone}}\\n$2"
    },
    {
      "path": "src/pdf/templates/Report.html",
      "description": "Style all tables as finance tables (if any plain <table> remain).",
      "find_regex": "<table(?![^>]*class=)[^>]*>",
      "replace": "<table class=\\\"table\\\">"
    },
    {
      "path": "src/pdf/templates/Report.html",
      "description": "Right-align numeric <td> heuristically for currency and percentages.",
      "find_regex": "<td>(\\$[^<]*|[0-9][^<%]*%|[0-9][^<]*)</td>",
      "replace": "<td class=\\\"num\\\">$1</td>"
    },
    {
      "path": "src/pdf/templates/Report.html",
      "description": "Add concise Assumptions card below Inputs/Assumptions section (if not present).",
      "find_regex": "(<section[^>]*id=[\\\"']inputs-section[\\\"'][^>]*>[\\s\\S]*?</section>)",
      "replace": "$1\\n<div class=\\\"section card avoid-break\\\">\\n  <div class=\\\"h2\\\">Assumptions<\\/div>\\n  <ul class=\\\"small\\\">\\n    <li>Tax/tip reversed out before applying price differential, then re-applied.<\\/li>\\n    <li>Out-of-pocket = Adjusted Volume × Interchange − Differential collected.<\\/li>\\n    <li>All signage and receipt disclosures included (Dual Pricing compliant).<\\/li>\\n  </ul>\\n</div>"
    },
    {
      "path": "src/pdf/templates/Report.html",
      "description": "Remove stray literal 'inputs' orphan tokens (first occurrence only).",
      "find_regex": ">(\\s*|\\n)*inputs(\\s*|\\n)*<",
      "replace": "><"
    },
    {
      "path": "src/pdf/templates/Report.html",
      "description": "Fix any literal 'Dual_Pricing' text in static copy.",
      "find_regex": "Dual_Pricing",
      "replace": "Dual Pricing"
    }
  ],
  "files_create_or_update_optional": [
    {
      "path": "src/pdf/render.ts",
      "contents": "import { fmtMoney, fmtPct, safeJoin, humanizeProgram } from '../helpers/formatters';\\n// DO NOT recompute: rely on frozen calculatedValues injected upstream\\n// eslint-disable-next-line @typescript-eslint/no-explicit-any\\nconst values:any = (globalThis as any).calculatedValues || {};\\nconst programLabel = humanizeProgram(values.programType);\\nconst cityState = safeJoin(values.merchantCity, values.merchantState);\\nexport const view = { ...values, programLabel, cityState };"
    }
  ],
  "commands": [
    { "name": "Build", "run": "pnpm build || npm run build || yarn build" },
    { "name": "DocRaptor Test Render", "run": "node scripts/docraptor-test.js", "optional": true }
  ],
  "verification": [
    "Title 'Fee Recovery Analysis' is centered at 20px with a thin rule, followed by merchant/date/report #.",
    "Page 1 shows KPIs followed immediately by a three-column 'Next Steps' band (no page break).",
    "'Dual_Pricing' appears as 'Dual Pricing' everywhere (programLabel + static text fix).",
    "Contact block shows only fields that exist (no 'undefined' or empty mailto).",
    "All tables use .table styles; numeric cells are right-aligned with tabular numerals.",
    "An Assumptions card appears below the Inputs section with three concise bullets.",
    "PDF metadata (title/subject/author) present in file properties.",
    "No stray 'inputs' orphan on Page 1."
  ],
  "outputs": [
    "DMP_Fee_Recovery_Report_Test.pdf"
  ],
  "rollback": {
    "note": "Remove the CSS link to mvp-polish.css and revert Report.html and render.ts via VCS. Delete scripts/docraptor-test.js if not needed."
  }
}
