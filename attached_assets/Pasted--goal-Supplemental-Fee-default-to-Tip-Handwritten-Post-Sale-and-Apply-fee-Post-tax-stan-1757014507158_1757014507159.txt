{
  "goal": "Supplemental Fee: default to Tip Handwritten – Post Sale and Apply fee: Post tax; standardize the UI to the new Excel-style layout across ALL Supplemental Fee variations; keep Card volume basis toggle; mirror in PDF; do not change Dual Pricing.",
  "files_to_edit": [
    "client/src/types/calculator.ts",
    "client/src/components/calculator/InputForm.tsx",
    "client/src/components/calculator/DualPricingBreakdown.tsx",
    "client/src/components/calculator/ProcessingSavings.tsx",
    "client/src/utils/calculations.ts",
    "server/pdf-generator-branded.ts"
  ],
  "instructions": [
    "types/calculator.ts:",
    "  - Ensure these enums/fields exist (or add if missing):",
    "      export type FeeTiming = 'FEE_BEFORE_TIP' | 'FEE_AFTER_TIP';",
    "      export type FeeTaxBasis = 'POST_TAX' | 'PRE_TAX';",
    "      export type CardVolumeBasis = 'PRE_TAX' | 'GROSS';",
    "  - In CalculatorInputs, include:",
    "      feeTiming?: FeeTiming;        // default: 'FEE_BEFORE_TIP'",
    "      feeTaxBasis?: FeeTaxBasis;    // default: 'POST_TAX'",
    "      cardVolumeBasis?: CardVolumeBasis; // default: 'PRE_TAX' (leave as-is unless you want Gross by default)",
    "  - In CalculatorResults, add fields used by the Excel layout:",
    "      baseVolumePreTaxPreTip?: number;",
    "      baseVolumeTaxedPreTip?: number;",
    "      processingCostSavingsOnly?: number;",
    "      processingCostSavingsPct?: number;",
    "      totalNetGainRevenue?: number;",
    "      annualNetGainRevenue?: number;",
    "",
    "client/src/components/calculator/InputForm.tsx (Supplemental Fee mode only):",
    "  - DEFAULTS: when programType switches to 'SUPPLEMENTAL_FEE' and the form has no values yet, set:",
    "      feeTiming = 'FEE_BEFORE_TIP'  // label: 'Tip Handwritten – Post Sale'",
    "      feeTaxBasis = 'POST_TAX'      // label: 'Apply fee: Post tax'",
    "  - Keep the existing radio groups but ensure labels are:",
    "      Fee timing:",
    "        • 'Tip Handwritten – Post Sale' (value 'FEE_BEFORE_TIP')",
    "        • 'Tip at Time of Sale'        (value 'FEE_AFTER_TIP')",
    "      Apply fee:",
    "        • 'Post tax' (value 'POST_TAX')",
    "        • 'Pre-tax'  (value 'PRE_TAX')",
    "      Card volume is:",
    "        • 'Pre-tax'  (value 'PRE_TAX')",
    "        • 'Gross (includes tax & tip)' (value 'GROSS')",
    "  - Make sure these three groups are always shown in Supplemental Fee mode (any combination).",
    "",
    "client/src/utils/calculations.ts (SUPPLEMENTAL_FEE branch; applies to ALL combinations):",
    "  - Read inputs with defaults:",
    "      const basis     = inputs.cardVolumeBasis || 'PRE_TAX';",
    "      const feeBasis  = inputs.feeTaxBasis     || 'POST_TAX';",
    "      const timing    = inputs.feeTiming       || 'FEE_BEFORE_TIP';",
    "  - Derive base volumes for display (used in every Supplemental variation):",
    "      const basePreTaxPreTip = (basis === 'GROSS') ? (cc / (1 + tax + tip)) : cc;",
    "      const baseTaxedPreTip  = basePreTaxPreTip * (1 + tax);",
    "  - Card processed total (processor basis):",
    "      const cardProcessedTotal = timing === 'FEE_BEFORE_TIP'",
    "        ? baseTaxedPreTip * (1 + fee) * (1 + tip)   // Tip Handwritten – Post Sale (fee before tip)",
    "        : baseTaxedPreTip * (1 + tip) * (1 + fee);  // Tip at Time of Sale (fee after tip)",
    "  - Fee base on cards (driven by feeBasis × timing × cardVolumeBasis):",
    "      let feeBaseForCards: number;",
    "      if (timing === 'FEE_BEFORE_TIP') {",
    "        feeBaseForCards = (feeBasis === 'POST_TAX') ? baseTaxedPreTip : basePreTaxPreTip;",
    "      } else {",
    "        feeBaseForCards = ((feeBasis === 'POST_TAX') ? baseTaxedPreTip : basePreTaxPreTip) * (1 + tip);",
    "      }",
    "      const cardFeeCollected  = feeBaseForCards * fee;",
    "      const cashFeeCollected  = cash * fee; // cash fee stays on pre-tax cash volume",
    "      const collectedValue    = cardFeeCollected + cashFeeCollected;",
    "  - Program card fees and signed row:",
    "      const processorChargeOnCards   = cardProcessedTotal * fr;",
    "      const netCostForProcessingCards = cardFeeCollected - processorChargeOnCards; // signed; can be negative",
    "  - Residual/overage for savings math (unchanged):",
    "      const residualCardCost  = Math.max(processorChargeOnCards - cardFeeCollected, 0);",
    "      const cardProgramProfit = Math.max(cardFeeCollected - processorChargeOnCards, 0);",
    "  - Savings pieces matching Excel layout (computed for all variations):",
    "      const processingCostSavingsOnly = currentCost - residualCardCost;",
    "      const processingCostSavingsPct  = currentCost > 0 ? processingCostSavingsOnly / currentCost : 0;",
    "      const totalNetGainRevenue       = processingCostSavingsOnly + cashFeeCollected;",
    "      const annualNetGainRevenue      = totalNetGainRevenue * 12;",
    "  - Return these fields (in addition to the ones you already return):",
    "      return {",
    "        ...existingFields,",
    "        baseVolumePreTaxPreTip: basePreTaxPreTip,",
    "        baseVolumeTaxedPreTip: baseTaxedPreTip,",
    "        cardProcessedTotal,",
    "        cardFeeCollected,",
    "        cashFeeCollected,",
    "        collectedValue,",
    "        processorChargeOnCards,",
    "        netCostForProcessingCards,",
    "        residualCardCost,",
    "        cardProgramProfit,",
    "        processingCostSavingsOnly,",
    "        processingCostSavingsPct,",
    "        totalNetGainRevenue,",
    "        annualNetGainRevenue,",
    "        monthlySavings,",
    "        annualSavings",
    "      };",
    "",
    "client/src/components/calculator/DualPricingBreakdown.tsx (programType==='SUPPLEMENTAL_FEE'):",
    "  - Use ONE standardized layout (regardless of timing or fee basis):",
    "      • 'Base Volume (pre-tax & pre-tip)'                         → results.baseVolumePreTaxPreTip",
    "      • 'Base Volume (with tax but pre-tip)'                      → results.baseVolumeTaxedPreTip",
    "      • 'Fee Collected on Cards'                                  → results.cardFeeCollected",
    "      • 'Fee Collected on Cash'                                   → results.cashFeeCollected",
    "      • 'Total Fee Collected (Card + Cash)'                       → results.collectedValue",
    "      • 'Total Cards Processed (incl tax, supp fee, & tips)'      → results.cardProcessedTotal",
    "      • 'Total Cost for Processing Cards (new)'                   → results.processorChargeOnCards",
    "      • 'Net Cost for Processing Cards (include tax + tips)'      → results.netCostForProcessingCards",
    "  - Keep the currency formatting and parentheses for negatives.",
    "",
    "client/src/components/calculator/ProcessingSavings.tsx (programType==='SUPPLEMENTAL_FEE'):",
    "  - Use ONE standardized layout for all variations:",
    "      • 'Current Processing Cost'                                → results.currentCost",
    "      • 'Net Cost for Processing Cards (include tax + tips)'     → results.netCostForProcessingCards",
    "      • 'Processing Cost Savings (Only)'                         → results.processingCostSavingsOnly",
    "      • 'Processing Cost Savings %'                              → results.processingCostSavingsPct (format as %; e.g., (val*100).toFixed(0–2))",
    "      • 'Fee Collected on Cash'                                  → results.cashFeeCollected",
    "      • 'Total Net Gain Revenue'                                 → results.totalNetGainRevenue (highlight)",
    "      • 'Annual Net Gain Revenue'                                → results.annualNetGainRevenue (secondary)",
    "  - Leave any Gross Profit / Skytab lines as they are now; they will pick up from your configured basis.",
    "",
    "server/pdf-generator-branded.ts (Supplemental Fee branch):",
    "  - Mirror the exact standardized row order/labels above for BOTH the Live/Breakdown and the Savings sections.",
    "  - In the Inputs table include:",
    "      • 'Card volume is:' Pre-tax | Gross (includes tax & tip)",
    "      • 'Apply fee:' Post tax | Pre-tax",
    "      • 'Tip mode:' Tip Handwritten – Post Sale | Tip at Time of Sale",
    "  - No changes to Dual Pricing PDF path."
  ],
  "tests": [
    "Default state (when user switches to Supplemental Fee): feeTiming = 'FEE_BEFORE_TIP'; feeTaxBasis = 'POST_TAX'.",
    "Numbers sanity checks with Card=20000, Cash=5000, Tax=10%, Tip=20%, Fee=4%, FR=3.85%, Current=2.25%:",
    "  A) cardVolumeBasis='PRE_TAX', POST_TAX + FEE_BEFORE_TIP → Fee on Cards ≈ 880.00; Processed ≈ 27,456.00; Program ≈ 1,057.06; Net (signed) ≈ -177.06; Total Net Gain Revenue ≈ 472.94.",
    "  B) cardVolumeBasis='GROSS', POST_TAX + FEE_BEFORE_TIP → Base pre-tax ≈ 15,384.62; Base taxed ≈ 16,923.08; Fee on Cards ≈ 676.92; Processed ≈ 21,120.00; Program ≈ 813.12; Net (signed) ≈ -136.20; Total Net Gain Revenue ≈ 513.80.",
    "  C) PRE_TAX + FEE_AFTER_TIP → Fee on Cards ≈ 960.00; processed/program adjust accordingly; standardized rows still visible.",
    "UI and PDF show identical rows/labels for all Supplemental Fee combinations."
  ],
  "success_criteria": [
    "Supplemental Fee defaults to Tip Handwritten – Post Sale and Apply fee: Post tax.",
    "The Excel-style rows appear for ALL Supplemental Fee combinations (not just one).",
    "Card volume basis toggle present; numbers change correctly for Pre-tax vs Gross.",
    "Dual Pricing/Cash Discounting behavior and labels remain unchanged."
  ]
}
