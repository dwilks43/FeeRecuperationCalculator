{
  "goal": "Supplemental Fee mode: pre-populate flat rate = fee/(1+fee), allow editing fee or flat rate independently, and recalc savings with possible card profit or residual cost.",
  "files_to_edit": [
    "client/src/types/calculator.ts",
    "client/src/utils/calculations.ts",
    "client/src/components/calculator/InputForm.tsx",
    "client/src/components/calculator/ProcessingSavings.tsx",
    "client/src/components/calculator/DualPricingBreakdown.tsx",
    "server/pdf-generator-branded.ts"
  ],
  "instructions": [
    "types/calculator.ts: In CalculatorInputs add `programType: 'DUAL_PRICING' | 'SUPPLEMENTAL_FEE'`. Continue to use `priceDifferential` for percentage input. Add `flatRatePct?: number` (percent) for Supplemental Fee mode. In CalculatorResults add `derivedFlatRate?: number`, `cardProgramProfit?: number`, `residualCardCost?: number`, `extraRevenueCash?: number`, and `collectedLabel/collectedValue` (already used).",
    "InputForm.tsx: When programType === 'SUPPLEMENTAL_FEE':",
    "  - Relabel priceDifferential to 'Supplemental Fee (%)'.",
    "  - Show an additional numeric input 'Flat Rate (%) (applied to fee-inclusive card amount)'.",
    "  - Introduce local state `autoSynced = true` initially. When the user first edits the flat rate field, set `autoSynced = false`.",
    "  - On program switch to SUPPLEMENTAL_FEE or when fee changes AND autoSynced === true, set `flatRatePct = (fee / (1 + fee)) * 100` (fee in decimal).",
    "  - Add two small helper links under the fields:",
    "      • 'Reset flat rate to offset' → sets flatRatePct = (fee/(1+fee))*100 and sets autoSynced = true.",
    "      • 'Compute fee from flat rate' → sets priceDifferential = (fr/(1-fr))*100 (inverse mapping) and sets autoSynced = false.",
    "  - Hide/disable Interchange & any Dual Pricing–only controls in Supplemental Fee mode.",
    "calculations.ts: In computeResults(inputs), branch by programType.",
    "  SUPPLEMENTAL_FEE branch:",
    "    const cc = inputs.monthlyCardVolume || 0;",
    "    const cash = inputs.monthlyCashVolume || 0;",
    "    const fee = (inputs.priceDifferential || 0) / 100; // Supplemental Fee %",
    "    const fr = (inputs.flatRatePct != null ? inputs.flatRatePct : (fee/(1+fee))*100) / 100; // Flat Rate %",
    "    const currentCost = cc * ((inputs.currentRate || 0) / 100);",
    "    // Fee collected",
    "    const suppFeeCollected = (cc + cash) * fee;",
    "    const extraRevenueCash = cash * fee;",
    "    // Processor charges merchant flat rate on the fee-inclusive card total",
    "    const processorChargeOnCards = cc * (1 + fee) * fr;",
    "    // Card fee revenue collected on cards",
    "    const cardFeeCollected = cc * fee;",
    "    // Net card processing burden (positive = merchant still pays some cost; negative = program profit on cards)",
    "    const cardNet = processorChargeOnCards - cardFeeCollected;",
    "    const residualCardCost = Math.max(cardNet, 0);",
    "    const cardProgramProfit = Math.max(-cardNet, 0);",
    "    // New out-of-pocket processing cost used for savings comparison",
    "    const newCost = residualCardCost; // DO NOT clamp profit here; profit is reported separately",
    "    const processingSavings = currentCost - residualCardCost; // if profit exists, savings > currentCost is shown via the separate profit line",
    "    const monthlySavings = processingSavings + extraRevenueCash + cardProgramProfit;",
    "    const annualSavings = monthlySavings * 12;",
    "    return { ...existing, currentCost, newCost, processingSavings, extraRevenueCash, cardProgramProfit, monthlySavings, annualSavings, collectedLabel: 'Supplemental Fee Collected', collectedValue: suppFeeCollected, derivedFlatRate: (fee/(1+fee))*100, residualCardCost };",
    "  DUAL_PRICING branch: unchanged.",
    "ProcessingSavings.tsx:",
    "  - When programType === 'SUPPLEMENTAL_FEE', rename card title to 'Monthly Savings'. Render rows in this order:",
    "      1) Current Processing Cost",
    "      2) Processing Savings (vs. current)",
    "      3) Extra Revenue on Cash Sales",
    "      4) Card Program Profit (show only if > 0)",
    "      5) Residual Card Processing Cost (show only if > 0)",
    "      Highlight 'Total Monthly Savings' = results.monthlySavings.",
    "DualPricingBreakdown.tsx:",
    "  - Replace hardcoded label with results.collectedLabel / collectedValue.",
    "  - In Supplemental Fee mode, display a small subtext: 'Fee basis: Card + Cash • Processor Flat Rate is applied to fee-inclusive card totals.'",
    "  - If results.derivedFlatRate exists, show a read-only hint: '100% offset pair: FR = fee/(1+fee) ≈ {derivedFlatRate.toFixed(4)}%'.",
    "server/pdf-generator-branded.ts:",
    "  - Inputs table: add Program Type, Supplemental Fee (%), Flat Rate (%).",
    "  - Savings section (when Supplemental Fee): list rows exactly as UI (Processing Savings, Extra Revenue on Cash Sales, Card Program Profit if any, Residual Card Cost if any, Total Monthly Savings).",
    "  - Keep formatting/rounding identical to UI utilities."
  ],
  "tests": [
    "Perfect offset pair: cc=100000, cash=25000, currentRate=3.0, fee=4.0, flatRate auto => fr=3.8461538%. processorChargeOnCards=100000*1.04*0.038461538=4000; cardFeeCollected=4000; cardNet=0; residual=0; cardProgramProfit=0; currentCost=3000; processingSavings=3000; extraRevenueCash=1000; monthlySavings=4000; annual=48000; collected=(125000*4%)=5000.",
    "Restaurant negotiates LOWER flat rate: same inputs but fr=3.60%. processorChargeOnCards=100000*1.04*0.036=3744; cardNet=3744-4000=-256; residual=0; cardProgramProfit=256; processingSavings=3000; monthlySavings=3000+1000+256=4256; annual=51072.",
    "Customer-facing fee reduced: fee=3.0%, fr kept at 3.8461538%. processorChargeOnCards=100000*1.03*0.038461538=3961.54; cardFeeCollected=3000; cardNet=961.54; residual=961.54; currentCost=3000; processingSavings=2038.46; extraRevenueCash=750; monthlySavings=2038.46+750=2788.46; collected=(125000*3%)=3750.",
    "Zero cash case: cash=0; ensure extraRevenueCash=0 and calculations still correct.",
    "Dual Pricing regression: previous fixtures remain unchanged."
  ],
  "success_criteria": [
    "On entering Supplemental Fee, flat rate pre-fills to fee/(1+fee).",
    "Editing fee OR flat rate updates results immediately without auto-overwriting the other (unless 'Reset' links are used).",
    "UI and PDF show identical numbers and labels for both programs.",
    "Card Program Profit and Residual Card Cost rows appear only when applicable.",
    "Dual Pricing results are unaffected by these changes."
  ]
}
