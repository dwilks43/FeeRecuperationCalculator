{
  "goal": "Supplemental Fee: account for tips written after the card is processed by applying flat rate to (fee-inclusive + tip) card totals; expose the residual as a tip adjustment against savings.",
  "files_to_edit": [
    "client/src/types/calculator.ts",
    "client/src/utils/calculations.ts",
    "client/src/components/calculator/InputForm.tsx",
    "client/src/components/calculator/ProcessingSavings.tsx",
    "client/src/components/calculator/DualPricingBreakdown.tsx",
    "server/pdf-generator-branded.ts"
  ],
  "instructions": [
    "types/calculator.ts:",
    "  - In CalculatorInputs, add optional `tipBasis?: 'fee_inclusive' | 'pre_fee'` (default 'fee_inclusive').",
    "  - In CalculatorResults, add `tipAdjustmentResidual?: number` and `tipAssumptionNote?: string`.",
    "InputForm.tsx (SUPPLEMENTAL_FEE mode):",
    "  - Re-enable the Tip % input (no longer disabled).",
    "  - Add a small selector for Tip Basis with options:",
    "      • 'Tip % of amount after fee' (value: 'fee_inclusive', default)",
    "      • 'Tip % of amount before fee' (value: 'pre_fee')",
    "  - Helper text: 'Tips are added after the fee. The processor flat rate applies to fee-inclusive + tip card totals.'",
    "calculations.ts (SUPPLEMENTAL_FEE branch):",
    "  // Inputs",
    "  const cc = inputs.monthlyCardVolume || 0;          // card purchase volume (pre-fee)",
    "  const cash = inputs.monthlyCashVolume || 0;        // cash purchase volume (pre-fee)",
    "  const fee = (inputs.priceDifferential || 0) / 100; // supplemental fee %",
    "  const fr = ((inputs.flatRatePct ?? (fee / (1 + fee) * 100)) / 100); // flat rate %",
    "  const tipRate = (inputs.tipRate || 0) / 100;      // tip %",
    "  // Fee collected",
    "  const cardFeeCollected = cc * fee;",
    "  const cashFeeCollected = cash * fee;",
    "  const suppFeeCollected = cardFeeCollected + cashFeeCollected;",
    "  const extraRevenueCash = cashFeeCollected;",
    "  // Tip math (assumption default = 'fee_inclusive'):",
    "  // Card processed total = cc * (1 + fee) * (1 + tipRate) when 'fee_inclusive'",
    "  // If 'pre_fee', then tip is cc * tipRate, so processed = cc * (1 + fee) + (cc * tipRate)",
    "  const tipBasis = inputs.tipBasis || 'fee_inclusive';",
    "  const cardProcessedTotal = tipBasis === 'fee_inclusive'",
    "    ? cc * (1 + fee) * (1 + tipRate)",
    "    : cc * (1 + fee) + cc * tipRate;",
    "  // Processor charges flat rate on the processed card total",
    "  const processorChargeOnCards = cardProcessedTotal * fr;",
    "  // Net burden on cards after fee collected on cards",
    "  const cardNet = processorChargeOnCards - cardFeeCollected;",
    "  const residualCardCost = Math.max(cardNet, 0);",
    "  const cardProgramProfit = Math.max(-cardNet, 0);",
    "  // Record the portion attributable to tips as a 'tip adjustment' residual",
    "  // Tip-only portion of processed card total:",
    "  const tipPortion = tipBasis === 'fee_inclusive'",
    "    ? (cc * (1 + fee) * tipRate)",
    "    : (cc * tipRate);",
    "  const tipAdjustmentResidual = Math.max(tipPortion * fr, 0);",
    "  // Savings math",
    "  const currentCost = cc * ((inputs.currentRate || 0) / 100);",
    "  const processingSavings = currentCost - residualCardCost; // if profit exists, it's reported separately",
    "  const monthlySavings = processingSavings + extraRevenueCash + cardProgramProfit;",
    "  const annualSavings = monthlySavings * 12;",
    "  const tipAssumptionNote = tipBasis === 'fee_inclusive' ? 'Tip % applied on fee-inclusive amount' : 'Tip % applied on pre-fee amount';",
    "  // Return results (keep existing fields you already return) and set labels",
    "  return {",
    "    ...baseResults,",
    "    collectedLabel: 'Supplemental Fee Collected',",
    "    collectedValue: suppFeeCollected,",
    "    currentCost,",
    "    newCost: residualCardCost,",
    "    processingSavings,",
    "    extraRevenueCash,",
    "    cardProgramProfit,",
    "    tipAdjustmentResidual,",
    "    monthlySavings,",
    "    annualSavings,",
    "    derivedFlatRate: (fee / (1 + fee)) * 100,",
    "    tipAssumptionNote",
    "  };",
    "ProcessingSavings.tsx (SUPPLEMENTAL_FEE mode):",
    "  - Keep the 'Monthly Savings' card. Show rows in this order:",
    "      1) Current Processing Cost",
    "      2) Processing Savings (vs. current)",
    "      3) Extra Revenue on Cash Sales",
    "      4) Card Program Profit (show if > 0)",
    "      5) Tip Adjustment (Residual Card Cost) — show if tipAdjustmentResidual > 0 (use the computed value, not just residualCardCost)",
    "      6) Residual Card Processing Cost (total) — show if residualCardCost > 0",
    "     • Highlight 'Total Monthly Savings' = monthlySavings",
    "  - Under the list, render a faint note: results.tipAssumptionNote",
    "DualPricingBreakdown.tsx:",
    "  - Subtext in Supplemental Fee mode: 'Fee basis: Card + Cash • Processor FR applies to fee-inclusive + tip card totals.'",
    "server/pdf-generator-branded.ts:",
    "  - Inputs table: include Tip % and Tip Basis when programType === 'SUPPLEMENTAL_FEE'.",
    "  - Savings section (SUPPLEMENTAL_FEE): add line items 'Tip Adjustment (Residual Card Cost)' (if > 0) and the overall 'Residual Card Processing Cost' (if > 0), then 'Total Monthly Savings'.",
    "  - Include the same tip assumption note in small text."
  ],
  "tests": [
    "Example from user: $10 item, fee=4%, FR=3.8461538%, tip=20% fee-inclusive: processed = 10*1.04*1.20=12.48; processorCharge=12.48*0.038461538≈0.48; cardFeeCollected=0.40; residual≈0.08; tipAdjustmentResidual≈(10*1.04*0.20)*0.038461538≈0.08.",
    "Monthly sanity: cc=100000, cash=25000, currentRate=3.0, fee=4.0, FR=3.8461538%, tip=20% fee-inclusive:",
    "  - cardProcessedTotal = 100000*1.04*1.20 = 124800",
    "  - processorCharge = 124800*0.038461538 ≈ 4800",
    "  - cardFeeCollected = 100000*0.04 = 4000",
    "  - residualCardCost ≈ 800",
    "  - currentCost = 3000",
    "  - processingSavings = 2200",
    "  - extraRevenueCash = 25000*0.04 = 1000",
    "  - monthlySavings = 2200 + 1000 = 3200 (no card profit in this case)",
    "  - tipAdjustmentResidual ≈ (100000*1.04*0.20)*0.038461538 ≈ 800",
    "Tip basis toggle check (pre_fee): same inputs but tip basis = 'pre_fee':",
    "  - cardProcessedTotal = 100000*1.04 + 100000*0.20 = 124000",
    "  - processorCharge ≈ 4769.23; residual ≈ 769.23; tipAdjustmentResidual ≈ (100000*0.20)*0.038461538 ≈ 769.23.",
    "Profit case: fee=4%, FR=3.60%, tip=15% fee-inclusive:",
    "  - cardProcessedTotal = 100000*1.04*1.15 = 119600; processorCharge = 4305.6; cardFeeCollected = 4000;",
    "  - cardNet = 305.6 → residual 305.6 (still a residual due to tips despite low FR); if FR set to ~3.205% exact, residual → ~0.",
    "Regression: Dual Pricing results remain identical."
  ],
  "success_criteria": [
    "SUPPLEMENTAL_FEE mode now decreases savings appropriately when tips are present.",
    "Tip basis default is 'fee_inclusive', and changing it updates results immediately.",
    "UI and PDF display 'Tip Adjustment (Residual Card Cost)' when applicable and the tip assumption note.",
    "All rounding/formatting matches UI and PDF identically."
  ]
}
