{
  "goal": "Keep existing labels for Supplemental Fee, add 'Fee timing' (before or after tips), update math accordingly, move Annual Savings under the total, remove the Annual Impact section, and rename 'Total Monthly Savings' to 'Savings'. Dual Pricing unchanged.",
  "files_to_edit": [
    "client/src/types/calculator.ts",
    "client/src/utils/calculations.ts",
    "client/src/components/calculator/InputForm.tsx",
    "client/src/components/calculator/ProcessingSavings.tsx",
    "client/src/components/calculator/DualPricingBreakdown.tsx",
    "server/pdf-generator-branded.ts"
  ],
  "instructions": [
    "types/calculator.ts:",
    "  - Extend CalculatorInputs with `feeTiming: 'FEE_BEFORE_TIP' | 'FEE_AFTER_TIP'`.",
    "  - Keep existing fields. No removals.",
    "",
    "InputForm.tsx (Supplemental Fee mode only):",
    "  - Add a new radio group 'Fee timing' with options:",
    "      • 'Fee added before tips' → value 'FEE_BEFORE_TIP' (default)",
    "      • 'Fee added after tips' → value 'FEE_AFTER_TIP'",
    "  - Place it near Tip % so the relationship is obvious.",
    "  - Do not change any other labels (keep your current wording).",
    "",
    "calculations.ts (SUPPLEMENTAL_FEE branch):",
    "  - Keep all existing variables. Implement fee-timing logic as follows (tax is applied first in both cases):",
    "    const cc = inputs.monthlyCardVolume || 0; // pre-tax, pre-fee, pre-tip card volume",
    "    const cash = inputs.monthlyCashVolume || 0;",
    "    const tax = (inputs.taxRate || 0) / 100;",
    "    const tip = (inputs.tipRate || 0) / 100;",
    "    const fee = (inputs.priceDifferential || 0) / 100; // Supplemental Fee %",
    "    const fr  = ((inputs.flatRatePct ?? (fee/(1+fee)*100)) / 100); // Flat Rate %",
    "",
    "    const taxed = cc * (1 + tax);",
    "    let cardFeeCollected, cardProcessedTotal;",
    "    if (inputs.feeTiming === 'FEE_AFTER_TIP') {",
    "      // Fee is applied last → fee base includes tip",
    "      cardProcessedTotal = taxed * (1 + tip) * (1 + fee);",
    "      cardFeeCollected   = taxed * (1 + tip) * fee;",
    "    } else {",
    "      // Fee is applied before tips (current/default)",
    "      cardProcessedTotal = taxed * (1 + fee) * (1 + tip);",
    "      cardFeeCollected   = taxed * fee; // fee is post-tax, pre-tip",
    "    }",
    "",
    "    const cashFeeCollected = (inputs.monthlyCashVolume || 0) * fee; // keep as-is per current app",
    "    const suppFeeCollected = cardFeeCollected + cashFeeCollected; // Total Fee Collected (Card + Cash)",
    "    const processorChargeOnCards = cardProcessedTotal * fr; // Total Cost for Processing Cards (new)",
    "",
    "    // Your labels expect 'Net Cost for Processing Cards' to be fee_collected_on_cards minus program card fees (can be negative):",
    "    const netCostForProcessingCards = cardFeeCollected - processorChargeOnCards; // (include tax + tips)",
    "",
    "    // For savings math (unchanged):",
    "    const currentCost = cc * ((inputs.currentRate || 0) / 100);",
    "    const residualCardCost = Math.max(processorChargeOnCards - cardFeeCollected, 0); // card fees left",
    "    const cardProgramProfit = Math.max(cardFeeCollected - processorChargeOnCards, 0); // extra fee retained",
    "    const processingSavings = currentCost - residualCardCost;",
    "    const monthlySavings = processingSavings + cashFeeCollected + cardProgramProfit;",
    "    const annualSavings = monthlySavings * 12;",
    "",
    "    // Return all fields the UI/PDF use today (keep names you already added earlier):",
    "    return {",
    "      ...baseResults,",
    "      cardFeeCollected,",
    "      cashFeeCollected,",
    "      collectedValue: suppFeeCollected,",
    "      cardProcessedTotal,",
    "      processorChargeOnCards,",
    "      netCostForProcessingCards,",
    "      currentCost,",
    "      residualCardCost,",
    "      cardProgramProfit,",
    "      processingSavings,",
    "      monthlySavings,",
    "      annualSavings",
    "    };",
    "",
    "DualPricingBreakdown.tsx (when programType === 'SUPPLEMENTAL_FEE'):",
    "  - Keep your exact labels and order:",
    "      • 'Fee Collected on Cards' → results.cardFeeCollected",
    "      • 'Fee Collected on Cash' → results.cashFeeCollected",
    "      • 'Total Fee Collected (Card + Cash)' → results.collectedValue",
    "      • 'Total Cards Processed (incl fees & tips)' → results.cardProcessedTotal",
    "      • 'Total Cost for Processing Cards (new)' → results.processorChargeOnCards",
    "      • 'Net Cost for Processing Cards (include tax + tips)' → results.netCostForProcessingCards  // can be negative",
    "      • 'Total Net Gain Rev  (include fee collected on cash)' → results.netCostForProcessingCards + results.cashFeeCollected",
    "  - Keep currency formatting exactly as your existing components do (negatives in parens if that's your style).",
    "",
    "ProcessingSavings.tsx (when programType === 'SUPPLEMENTAL_FEE'):",
    "  - Keep the section title as 'Monthly Savings'.",
    "  - Keep your rows/labels and compute values as:",
    "      • 'Current Processing Cost' → results.currentCost",
    "      • 'Net Cost for Processing Cards (include tax + tips)' → results.netCostForProcessingCards",
    "      • 'Fee Collected on Cash' → results.cashFeeCollected",
    "      • Final total label: change from 'Total Monthly Savings' to **'Savings'** and use → results.monthlySavings",
    "      • Directly underneath, show 'Annual Savings' (results.annualSavings) in a small, secondary row.",
    "  - Remove the separate 'Annual Impact' card from the UI entirely.",
    "",
    "server/pdf-generator-branded.ts:",
    "  - In the Supplemental Fee branch, mirror your UI labels verbatim and the same values:",
    "      • Live Preview block with the 7 lines listed above.",
    "      • Monthly Savings block: same four lines and the total labeled 'Savings'.",
    "      • Move 'Annual Savings' to directly under 'Savings' in smaller text.",
    "  - Remove the 'Annual Impact' section for Supplemental Fee.",
    "  - Leave Dual Pricing PDF path unchanged.",
    "",
    "Notes:",
    "  - Do not alter Dual Pricing math or labels.",
    "  - Ensure `feeTiming` is persisted in the PDF payload so the numbers match."
  ],
  "tests": [
    "Fee BEFORE tips (default): B4=10000, B5=2500, tax=10%, tip=20%, fee=4%, FR=4%, current=2% →",
    "  Fee Collected on Cards = 10000*0.04 = 400.00",
    "  Fee Collected on Cash = 2500*0.04 = 100.00",
    "  Total Cards Processed = 10000*(1+0.10)*(1+0.04)*(1+0.20) = 13728.00",
    "  Total Cost for Processing Cards (new) = 13728*0.04 = 549.12",
    "  Net Cost for Processing Cards = 400.00 - 549.12 = -149.12",
    "  Total Net Gain Rev (incl fee on cash) = -149.12 + 100.00 = -49.12",
    "  Current Processing Cost = 10000*0.02 = 200.00",
    "  Savings (total) = processingSavings + cashFee + cardProfit = (200 - 149.12) + 100 + 0 = 150.88",
    "  Annual Savings = 1810.56 appears directly under 'Savings'.",
    "",
    "Fee AFTER tips: same inputs →",
    "  Fee Collected on Cards = 10000*(1+0.10)*(1+0.20)*0.04 = 528.00",
    "  Total Cards Processed remains 13728.00 (order commutes in this model),",
    "  Total Cost for Processing Cards (new) = 549.12",
    "  Net Cost for Processing Cards = 528.00 - 549.12 = -21.12",
    "  Total Net Gain Rev (incl fee on cash) = -21.12 + 100.00 = 78.88",
    "  Savings (total) = (200 - max(549.12-528.00,0)) + 100 + max(528.00-549.12,0) = 278.88",
    "  Annual Savings shown right under 'Savings'.",
    "",
    "UI: 'Annual Impact' card no longer appears. 'Savings' replaces 'Total Monthly Savings'.",
    "PDF: Matches UI labels, annual under total."
  ],
  "success_criteria": [
    "Two fee-timing models selectable; numbers update correctly.",
    "All labels remain exactly as provided by the user.",
    "Annual Savings sits under 'Savings'; 'Annual Impact' section removed.",
    "Dual Pricing remains unchanged in UI and PDF."
  ]
}
